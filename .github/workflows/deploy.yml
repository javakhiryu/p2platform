# Название workflow 
name: Deploy to production

# Триггеры для запуска workflow
on:
  push:
    branches: [ main ]  # Запускать workflow при пуше в ветку main

# Определение jobs (заданий)
jobs:

  # Job для сборки Docker-образа
  build:
    name: deploy  # Название job
    runs-on: ubuntu-latest  # Использовать последнюю версию Ubuntu для выполнения job

    # Шаги, которые будут выполнены в рамках job
    steps:

    # Шаг 1: Клонирование репозитория
    - name: Checkout
      uses: actions/checkout@v4  # Использование действия для клонирования репозитория

    - name: Install swag
      run: |
        go install github.com/swaggo/swag/cmd/swag@latest
        go get -u github.com/swaggo/gin-swagger
        go get -u github.com/swaggo/files
        export PATH=$(go env GOPATH)/bin:$PATH

    - name: Login to Personal ACR
      uses: aliyun/acr-login@v1
      with:
        login-server: https://crpi-qzh5i8b0hkdo3v4d.ap-southeast-1.personal.cr.aliyuncs.com
        region-id: ap-southeast-1
        access-key-id: ${{ secrets.ALIBABA_ACCESS_KEY_ID }}
        access-key-secret: ${{ secrets.ALIBABA_ACCESS_KEY_SECRET }}
        instance-id: crpi-qzh5i8b0hkdo3v4d
    
    - name: Build and push image
      run: |
        docker build -t crpi-qzh5i8b0hkdo3v4d.ap-southeast-1.personal.cr.aliyuncs.com/my-namespace/my-repo:${{ github.sha }} .
        docker push crpi-qzh5i8b0hkdo3v4d.ap-southeast-1.personal.cr.aliyuncs.com/my-namespace/my-repo:${{ github.sha }}
      